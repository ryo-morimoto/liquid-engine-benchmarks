# Benchmark Workflow
#
# Runs comprehensive benchmarks and updates README.md with results.
# Triggers: push to main, monthly schedule, manual dispatch.
#
# Security: All shell inputs use environment variables from trusted sources only.

name: Benchmark

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'scenarios/**'
      - 'leb.config.json'
      - '.github/workflows/benchmark.yml'

  schedule:
    # Monthly: 1st day at 00:00 UTC
    - cron: '0 0 1 * *'

  workflow_dispatch:
    inputs:
      scale:
        description: 'Data scale'
        required: true
        default: 'medium'
        type: choice
        options: [small, medium, large]
      iterations:
        description: 'Number of iterations'
        required: true
        default: '100'
        type: string

concurrency:
  group: benchmark-${{ github.ref }}
  cancel-in-progress: false

# Required for git-auto-commit-action to push changes
permissions:
  contents: write

jobs:
  bench:
    name: Run Benchmarks
    runs-on: ubuntu-latest

    env:
      SCALE: ${{ inputs.scale || 'medium' }}
      ITERATIONS: ${{ inputs.iterations || '100' }}

    steps:
      - uses: actions/checkout@v4

      # Extract runtime versions from config
      - name: Read config
        id: config
        run: |
          php_version=$(jq -r '.runtimes.php' leb.config.json)
          ruby_version=$(jq -r '.runtimes.ruby' leb.config.json)
          {
            echo "php_version=$php_version"
            echo "ruby_version=$ruby_version"
            echo "timestamp=$(date -u +%Y%m%d-%H%M%S)"
          } >> "$GITHUB_OUTPUT"

      - uses: oven-sh/setup-bun@v2

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ hashFiles('bun.lock') }}

      - run: bun install --frozen-lockfile

      # Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ steps.config.outputs.php_version }}
          extensions: mbstring
          tools: composer:v2

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - name: Install PHP dependencies
        run: |
          bun src/run.ts setup php
          composer install --no-interaction

      # Setup Ruby
      - name: Generate Gemfile
        run: bun src/run.ts setup ruby

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ steps.config.outputs.ruby_version }}
          bundler-cache: true

      # Seed benchmark database
      - name: Seed database
        run: bun src/run.ts prepare

      # Run benchmark and update README
      - name: Run benchmark
        run: |
          # Run benchmark and capture table output
          table_output=$(bun src/run.ts bench -f table -q)

          # Update README.md between markers (no code block for markdown table rendering)
          awk -v table="$table_output" '
            /<!-- CI_RESULTS_START -->/ {
              print
              print table
              skip = 1
              next
            }
            /<!-- CI_RESULTS_END -->/ {
              skip = 0
            }
            !skip
          ' README.md > README.md.tmp && mv README.md.tmp README.md

          # Output to job summary
          {
            echo "# Benchmark Results"
            echo ""
            echo "$table_output"
          } >> "$GITHUB_STEP_SUMMARY"

      # Commit README changes
      - name: Commit README updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update benchmark results"
          file_pattern: README.md
